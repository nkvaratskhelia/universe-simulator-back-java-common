= Project setup

This file contains documentation which applies to all projects.
Project-specific setup guides can be found in the
`development/project-setup.adoc` files in other projects.

== Https/TLS
To run applications with `TLS` you need a keystore. The certificate in the
keystore can be either self-signed or provided by a CA. You can use `openssl`
and java's `keytool` utility for working with keystore. To create all the
necessary files, follow these steps:

* Create a `~/universe-simulator` directory.

* In the `~/universe-simulator` directory create a keystore file with a
self-signed certificate and private key: `keytool -genkeypair -v
-alias universe-simulator -keystore universe-simulator.p12 -keyalg RSA
-validity 365 -ext SAN=dns:localhost,ip:127.0.0.1` +
#Enter some valid country code (e.g. _GE_) when prompted.#

* Extract the certificate from the keystore with:
`openssl pkcs12 -in universe-simulator.p12 -out universe-simulator-cert.pem
-nokeys`

* Extract the private key from the keystore with:
`openssl pkcs12 -in universe-simulator.p12 -out universe-simulator-key.pem
-nodes -nocerts`

* Add the certificate to your java `cacerts` truststore:
`keytool -importcert -v -cacerts -alias universe-simulator
-file universe-simulator-cert.pem` +
#Run the command with admin privileges. The default password for
java's _cacerts_ truststore is _changeit_.#

* Add the certificate to your operating system's trusted certificate list.

== Software
Go to the `development` directory (in the `common` project and in other
projects where it exists) and run `docker-compose -p universe-simulator up -d`
to install all required software components.

== Configuration

=== Consul
* Create a `config` folder in Consul's `Key/Value`.

* Inside the `config` folder create a `application` folder. Properties
in this folder will be available to all services for all profiles. Add
the following properties with `data` as key:

[source, json]
----
{
  "spring.cloud.consul.discovery.scheme": "https",
  "spring.cloud.consul.discovery.register-health-check": false,
  "server.ssl.key-store": "file:${HOME}/universe-simulator/universe-simulator.p12",
  "server.ssl.key-store-password": "{your-key-store-password}",
  "server.http2.enabled": true,
  "server.shutdown": "graceful",
  "spring.sleuth.sampler.probability": 1.0,
  "spring.zipkin.sender.type": "rabbit",
  "spring.rabbitmq.ssl.enabled": true,
  "spring.rabbitmq.template.exchange": "universe-simulator",
  "app.rabbitmq.event-queue": "event"
}
----

* Inside the `application` folder create a `local` folder. Properties
in this folder will be available to all services for `local` profile
only. Add the following properties with `data` as key:

[source, json]
----
{
  "spring.rabbitmq.username": "user",
  "spring.rabbitmq.password": "password",
  "app.logstash-url": "localhost:4560"
}
----

* You can add additional configuration in the `config` folder using the
`{application-name}/{profile}` pattern, where `application-name` maps
to the `spring.application.name` property in `application.properties`
and `profile` maps to your active spring boot profile.

=== Properties
Create a `application-local.properties` file next to
`application.properties` in all projects except `common` and add the
following properties:

----
spring.config.import=consul:
server.port={port-of-your-choice}
----

=== Environment variables
Add the following OS environment variables:

* `US_GITHUB_PACKAGES_USER`
* `US_GITHUB_PACKAGES_TOKEN`
* `US_CONSUL_HOST`
* `US_CONSUL_PORT`

== ELK

=== Templates
Go to `Stack Management > Index Management > Index Templates` in
`Kibana` and create the following index template:

* Name: `logstash`
* Index patterns: `logstash-*`
* Index settings:

[source, json]
----
{
  "index": {
    "number_of_shards": "1",
    "number_of_replicas": "0"
  }
}
----

=== Lifecycle policies
Go to `Stack Management > Index Lifecycle Policies` and add policies for
`zipkin` and `logstash`. E.g.:

* Policy name: `zipkin`
* Hot phase: Delete data after this phase
* Hot phase > Rollover: disable `Use recommended defaults`
* Hot phase > Rollover: disable `Enable rollover`

image::project-setup-elk-lifecycle-policies.png[]

* Add `logstash` policy to the `logstash` index template.
* Add `zipkin` policy to the `zipkin-span_template` index template. +
#This policy will be created automatically by zipkin.#

=== Index patterns
After starting applications, go to `Stack Management > Index Patterns`
and add the following index pattern:

* Name: `logstash-*`
* Timestamp field: `@timestamp`

You can add microservice-specific index patterns using the following
syntax: `logstash-{service}-*` where `service` maps to the
`spring.application.name` property in `application.properties`.

== Running an application
You can run an application with the `local` profile from your IDE or
with the following command: `./gradlew bootRun
--args='--spring.profiles.active=local'`.
